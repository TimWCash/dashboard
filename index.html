<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Physics - Resource Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary-blue: #2563eb;
            --primary-blue-dark: #1d4ed8;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            --purple: #8b5cf6;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-100);
            color: var(--gray-800);
            line-height: 1.5;
        }
        .dashboard { max-width: 1800px; margin: 0 auto; padding: 24px; }

        /* Loading state */
        .loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .loading-overlay.hidden { display: none; }
        .loading-spinner {
            width: 48px; height: 48px; border: 4px solid var(--gray-200);
            border-top-color: var(--primary-blue); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 16px; font-size: 16px; color: var(--gray-600); }
        .error-message { background: #fef2f2; color: #dc2626; padding: 16px 24px; border-radius: 8px; margin-top: 16px; max-width: 400px; text-align: center; }

        .header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 24px; padding: 20px 24px;
            background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
            border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .header h1 { font-size: 24px; font-weight: 700; color: white; display: flex; align-items: center; gap: 12px; }
        .header-meta { display: flex; align-items: center; gap: 16px; }
        .last-updated { font-size: 13px; color: rgba(255,255,255,0.8); }
        .sync-status { display: flex; align-items: center; gap: 6px; font-size: 12px; color: rgba(255,255,255,0.9); }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: #10b981; animation: pulse 2s infinite; }
        .sync-dot.error { background: #ef4444; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .header-btn {
            display: flex; align-items: center; gap: 6px; padding: 8px 16px;
            background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer;
            transition: all 0.2s;
        }
        .header-btn:hover { background: rgba(255,255,255,0.3); }
        .header-btn.primary { background: white; color: var(--primary-blue); border: none; }
        .tabs {
            display: flex; gap: 4px; margin-bottom: 24px; background: white;
            padding: 6px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        .tab {
            padding: 10px 20px; border: none; background: transparent; border-radius: 8px;
            font-size: 14px; font-weight: 500; color: var(--gray-600); cursor: pointer;
            white-space: nowrap; transition: all 0.2s;
        }
        .tab:hover { background: var(--gray-100); }
        .tab.active { background: var(--primary-blue); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .filters { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; align-items: center; }
        .filter-group { display: flex; align-items: center; gap: 8px; }
        .filter-label { font-size: 13px; font-weight: 500; color: var(--gray-600); }
        select, .search-input {
            padding: 8px 12px; border: 1px solid var(--gray-300); border-radius: 8px;
            font-size: 14px; color: var(--gray-700); cursor: pointer; min-width: 150px;
        }
        select {
            appearance: none; padding-right: 32px;
            background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2364748b' d='M2 4l4 4 4-4'/%3E%3C/svg%3E") no-repeat right 12px center;
        }
        select:focus, .search-input:focus { outline: none; border-color: var(--primary-blue); }
        .search-input {
            padding-left: 36px; width: 250px;
            background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E") no-repeat 10px center;
        }
        .kpi-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px; margin-bottom: 24px;
        }
        .kpi-card {
            background: white; border-radius: 12px; padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s;
        }
        .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .kpi-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .kpi-title { font-size: 12px; font-weight: 500; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-icon { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .kpi-icon.blue { background: rgba(37, 99, 235, 0.1); }
        .kpi-icon.green { background: rgba(16, 185, 129, 0.1); }
        .kpi-icon.orange { background: rgba(245, 158, 11, 0.1); }
        .kpi-icon.red { background: rgba(239, 68, 68, 0.1); }
        .kpi-icon.purple { background: rgba(139, 92, 246, 0.1); }
        .kpi-icon.cyan { background: rgba(6, 182, 212, 0.1); }
        .kpi-value { font-size: 28px; font-weight: 700; color: var(--gray-900); margin-bottom: 4px; }
        .kpi-change { display: flex; align-items: center; gap: 4px; font-size: 12px; }
        .kpi-change.positive { color: var(--success); }
        .kpi-change.negative { color: var(--danger); }
        .kpi-change.neutral { color: var(--gray-500); }
        .section-card {
            background: white; border-radius: 12px; padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px;
        }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px; }
        .section-title { font-size: 16px; font-weight: 600; color: var(--gray-800); }
        .section-actions { display: flex; gap: 8px; }
        .btn {
            display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px;
            border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer;
            transition: all 0.2s; border: none;
        }
        .btn-secondary { background: var(--gray-100); color: var(--gray-700); }
        .btn-secondary:hover { background: var(--gray-200); }
        .btn-primary { background: var(--primary-blue); color: white; }
        .btn-primary:hover { background: var(--primary-blue-dark); }
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
        @media (max-width: 1024px) { .charts-grid { grid-template-columns: 1fr; } }
        .chart-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .chart-title { font-size: 16px; font-weight: 600; color: var(--gray-800); }
        .chart-container { position: relative; height: 280px; }
        .capacity-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .resource-card { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .resource-card:hover { transform: translateY(-2px); }
        .resource-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--gray-100); }
        .avatar { width: 44px; height: 44px; border-radius: 50%; background: var(--primary-blue); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; }
        .resource-info { flex: 1; }
        .resource-name { font-weight: 600; font-size: 15px; color: var(--gray-800); }
        .resource-meta { font-size: 12px; color: var(--gray-500); display: flex; gap: 12px; margin-top: 2px; }
        .resource-type-badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; }
        .resource-type-badge.el { background: rgba(37, 99, 235, 0.1); color: var(--primary-blue); }
        .resource-type-badge.pl { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .resource-type-badge.special { background: rgba(139, 92, 246, 0.1); color: var(--purple); }
        .resource-type-badge.tbh { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .total-allocation { text-align: right; }
        .allocation-percent { font-size: 20px; font-weight: 700; color: var(--gray-900); }
        .allocation-label { font-size: 11px; color: var(--gray-500); }
        .project-allocations { display: flex; flex-direction: column; gap: 8px; }
        .project-row { display: flex; align-items: center; gap: 10px; }
        .project-name { width: 120px; font-size: 13px; color: var(--gray-700); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .allocation-bar { flex: 1; height: 20px; background: var(--gray-100); border-radius: 4px; overflow: hidden; }
        .allocation-fill { height: 100%; border-radius: 4px; display: flex; align-items: center; justify-content: flex-end; padding-right: 6px; font-size: 11px; font-weight: 600; color: white; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; font-size: 11px; font-weight: 600; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid var(--gray-200); white-space: nowrap; cursor: pointer; }
        th:hover { color: var(--gray-700); }
        th.sorted { color: var(--primary-blue); }
        td { padding: 12px; font-size: 13px; color: var(--gray-700); border-bottom: 1px solid var(--gray-100); }
        tr:hover { background: var(--gray-50); }
        .status-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
        .status-badge.allocated, .status-badge.converted { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .status-badge.funnel { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .status-badge.tbh { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .client-card { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 16px; border-left: 4px solid var(--primary-blue); }
        .client-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--gray-100); }
        .client-name { font-size: 18px; font-weight: 700; color: var(--gray-900); }
        .client-stats { display: flex; gap: 16px; }
        .client-stat { text-align: center; }
        .client-stat-value { font-size: 20px; font-weight: 700; color: var(--primary-blue); }
        .client-stat-label { font-size: 11px; color: var(--gray-500); }
        .team-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .team-member { display: flex; align-items: center; gap: 8px; background: var(--gray-50); padding: 8px 12px; border-radius: 8px; transition: all 0.2s; }
        .team-member:hover { background: var(--gray-100); }
        .team-member-avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px; color: white; }
        .team-member-info { }
        .team-member-name { font-size: 13px; font-weight: 500; color: var(--gray-800); }
        .team-member-role { font-size: 11px; color: var(--gray-500); }
        /* Pipeline/Funnel styles */
        .pipeline-container { display: flex; gap: 16px; margin-bottom: 24px; overflow-x: auto; padding-bottom: 8px; }
        .pipeline-stage { flex: 1; min-width: 250px; background: var(--gray-50); border-radius: 12px; padding: 16px; }
        .pipeline-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 2px solid; }
        .pipeline-header.converted { border-color: var(--success); }
        .pipeline-header.funnel { border-color: var(--warning); }
        .pipeline-header.tbh { border-color: var(--danger); }
        .pipeline-header.intro { border-color: #94a3b8; }
        .pipeline-header.pitch { border-color: #8b5cf6; }
        .pipeline-header.proposal { border-color: #f59e0b; }
        .pipeline-header.won { border-color: #10b981; }
        .pipeline-title { font-weight: 600; font-size: 14px; color: var(--gray-800); }
        .pipeline-count { font-size: 20px; font-weight: 700; }
        .pipeline-count.converted { color: var(--success); }
        .pipeline-count.funnel { color: var(--warning); }
        .pipeline-count.tbh { color: var(--danger); }
        .pipeline-item { background: white; border-radius: 8px; padding: 12px; margin-bottom: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .pipeline-item-name { font-weight: 500; font-size: 14px; color: var(--gray-800); }
        .pipeline-item-meta { font-size: 12px; color: var(--gray-500); margin-top: 4px; }
        .pipeline-item-value { font-size: 13px; color: var(--primary-blue); font-weight: 600; margin-top: 4px; }
        /* Timeline styles */
        .timeline { position: relative; padding-left: 24px; }
        .timeline::before { content: ''; position: absolute; left: 8px; top: 0; bottom: 0; width: 2px; background: var(--gray-200); }
        .timeline-item { position: relative; padding-bottom: 24px; }
        .timeline-dot { position: absolute; left: -20px; top: 4px; width: 12px; height: 12px; border-radius: 50%; background: var(--primary-blue); border: 2px solid white; box-shadow: 0 0 0 2px var(--primary-blue); }
        .timeline-dot.warning { background: var(--warning); box-shadow: 0 0 0 2px var(--warning); }
        .timeline-content { background: white; border-radius: 8px; padding: 12px 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .timeline-title { font-weight: 600; font-size: 14px; color: var(--gray-800); }
        .timeline-desc { font-size: 13px; color: var(--gray-600); margin-top: 4px; }
        .timeline-date { font-size: 11px; color: var(--gray-400); margin-top: 8px; }
        /* Contract card styles */
        .contract-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
        .contract-card { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-top: 4px solid var(--primary-blue); }
        .contract-name { font-size: 16px; font-weight: 700; color: var(--gray-900); margin-bottom: 12px; }
        .contract-detail { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--gray-100); font-size: 13px; }
        .contract-label { color: var(--gray-500); }
        .contract-value { color: var(--gray-800); font-weight: 500; }
        .footer { text-align: center; padding: 20px; color: var(--gray-500); font-size: 13px; }
        .footer a { color: var(--primary-blue); text-decoration: none; }
        /* Modal styles */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .modal-title { font-size: 18px; font-weight: 600; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray-400); }
        /* Export dropdown */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; right: 0; top: 100%; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 160px; z-index: 100; margin-top: 4px; }
        .dropdown:hover .dropdown-content { display: block; }
        .dropdown-item { display: block; padding: 10px 16px; font-size: 14px; color: var(--gray-700); cursor: pointer; text-decoration: none; }
        .dropdown-item:hover { background: var(--gray-50); }
        .dropdown-item:first-child { border-radius: 8px 8px 0 0; }
        .dropdown-item:last-child { border-radius: 0 0 8px 8px; }
        /* Recruitment funnel specific */
        .candidate-card { background: white; border-radius: 8px; padding: 12px; margin-bottom: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border-left: 3px solid var(--primary-blue); }
        .candidate-name { font-weight: 600; font-size: 14px; color: var(--gray-800); }
        .candidate-position { font-size: 12px; color: var(--gray-600); margin-top: 2px; }
        .candidate-stage { font-size: 11px; padding: 2px 8px; border-radius: 12px; background: var(--gray-100); color: var(--gray-600); display: inline-block; margin-top: 6px; }
        /* Alert styles */
        .alerts-container { margin-bottom: 24px; }
        .alert-card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid; display: flex; align-items: flex-start; gap: 12px; }
        .alert-card.warning { border-left-color: var(--warning); background: #fffbeb; }
        .alert-card.danger { border-left-color: var(--danger); background: #fef2f2; }
        .alert-card.info { border-left-color: var(--info); background: #ecfeff; }
        .alert-icon { font-size: 20px; flex-shrink: 0; }
        .alert-content { flex: 1; }
        .alert-title { font-weight: 600; font-size: 14px; color: var(--gray-800); margin-bottom: 4px; }
        .alert-desc { font-size: 13px; color: var(--gray-600); }
        .alert-action { font-size: 12px; color: var(--primary-blue); margin-top: 8px; cursor: pointer; }
        /* Month status grid - KPI card style */
        .month-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 16px; }
        @media (max-width: 1200px) { .month-grid { grid-template-columns: 1fr; } }
        .month-card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s; }
        .month-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .month-card.current { border-left: 4px solid var(--primary-blue); }
        .month-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--gray-100); }
        .month-title-area { display: flex; align-items: center; gap: 12px; }
        .month-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .month-icon.jan { background: linear-gradient(135deg, #dbeafe, #bfdbfe); }
        .month-icon.feb { background: linear-gradient(135deg, #fce7f3, #fbcfe8); }
        .month-icon.mar { background: linear-gradient(135deg, #d1fae5, #a7f3d0); }
        .month-icon.apr { background: linear-gradient(135deg, #fef3c7, #fde68a); }
        .month-icon.current { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; }
        .month-name { font-size: 18px; font-weight: 700; color: var(--gray-800); }
        .month-year { font-size: 13px; color: var(--gray-500); }
        .month-badge { font-size: 11px; padding: 4px 12px; border-radius: 20px; font-weight: 600; }
        .month-badge.current { background: var(--primary-blue); color: white; }
        .month-badge.upcoming { background: var(--gray-100); color: var(--gray-600); }
        .month-kpis { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 20px; }
        .month-kpi { padding: 16px; background: var(--gray-50); border-radius: 12px; text-align: center; }
        .month-kpi-value { font-size: 28px; font-weight: 700; color: var(--gray-900); line-height: 1; }
        .month-kpi-value.success { color: var(--success); }
        .month-kpi-value.warning { color: var(--warning); }
        .month-kpi-value.danger { color: var(--danger); }
        .month-kpi-label { font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 6px; }
        .month-kpi-sub { font-size: 11px; color: var(--gray-400); margin-top: 2px; }
        .month-details { border-top: 1px solid var(--gray-100); padding-top: 16px; }
        .detail-section { margin-bottom: 16px; }
        .detail-section:last-child { margin-bottom: 0; }
        .detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .detail-title { font-size: 12px; font-weight: 600; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.5px; }
        .detail-count { font-size: 12px; font-weight: 600; color: var(--gray-500); }
        .resource-list { display: flex; flex-direction: column; gap: 8px; }
        .resource-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--gray-50); border-radius: 8px; transition: background 0.2s; }
        .resource-item:hover { background: var(--gray-100); }
        .resource-avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px; color: white; flex-shrink: 0; }
        .resource-avatar.el { background: var(--primary-blue); }
        .resource-avatar.pl { background: var(--success); }
        .resource-avatar.tbh { background: var(--danger); }
        .resource-avatar.special { background: var(--purple); }
        .resource-info { flex: 1; min-width: 0; }
        .resource-name { font-size: 13px; font-weight: 600; color: var(--gray-800); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .resource-meta { font-size: 11px; color: var(--gray-500); display: flex; gap: 8px; }
        .resource-status { padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; }
        .resource-status.active { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .resource-status.tbh { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .resource-status.funnel { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .client-tags { display: flex; flex-wrap: wrap; gap: 6px; }
        .client-tag { display: inline-flex; align-items: center; gap: 4px; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 500; background: var(--gray-50); color: var(--gray-700); border: 1px solid var(--gray-200); }
        .client-tag .tag-dot { width: 6px; height: 6px; border-radius: 50%; }
        .client-tag .tag-dot.green { background: var(--success); }
        .client-tag .tag-dot.orange { background: var(--warning); }
        .client-tag .tag-dot.red { background: var(--danger); }
        .month-footer { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--gray-100); display: flex; justify-content: space-between; align-items: center; }
        .health-indicator { display: flex; align-items: center; gap: 8px; }
        .health-bar { width: 100px; height: 6px; background: var(--gray-200); border-radius: 3px; overflow: hidden; }
        .health-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
        .health-fill.green { background: var(--success); }
        .health-fill.orange { background: var(--warning); }
        .health-fill.red { background: var(--danger); }
        .health-text { font-size: 12px; font-weight: 600; }
        .health-text.green { color: var(--success); }
        .health-text.orange { color: var(--warning); }
        .health-text.red { color: var(--danger); }
        .empty-state { text-align: center; padding: 20px; color: var(--gray-400); font-size: 13px; }

        /* Gantt Chart Styles */
        .gantt-container { overflow-x: auto; background: white; border-radius: 12px; }
        .gantt-header { display: flex; border-bottom: 2px solid var(--gray-200); position: sticky; top: 0; background: white; z-index: 10; }
        .gantt-label-col { width: 200px; min-width: 200px; padding: 12px 16px; font-weight: 600; font-size: 12px; color: var(--gray-600); text-transform: uppercase; border-right: 1px solid var(--gray-200); }
        .gantt-timeline { display: flex; flex: 1; }
        .gantt-month { flex: 1; min-width: 120px; padding: 12px 8px; text-align: center; font-size: 12px; font-weight: 600; color: var(--gray-600); border-right: 1px solid var(--gray-100); }
        .gantt-month.current { background: rgba(37, 99, 235, 0.05); color: var(--primary-blue); }
        .gantt-body { }
        .gantt-row { display: flex; border-bottom: 1px solid var(--gray-100); min-height: 48px; }
        .gantt-row:hover { background: var(--gray-50); }
        .gantt-row-label { width: 200px; min-width: 200px; padding: 12px 16px; border-right: 1px solid var(--gray-200); display: flex; align-items: center; gap: 10px; }
        .gantt-row-name { font-size: 13px; font-weight: 500; color: var(--gray-800); }
        .gantt-row-meta { font-size: 11px; color: var(--gray-500); }
        .gantt-row-timeline { display: flex; flex: 1; position: relative; align-items: center; }
        .gantt-cell { flex: 1; min-width: 120px; border-right: 1px solid var(--gray-100); position: relative; }
        .gantt-bar { position: absolute; height: 24px; border-radius: 4px; top: 50%; transform: translateY(-50%); display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 500; color: white; min-width: 20px; cursor: pointer; transition: opacity 0.2s; }
        .gantt-bar:hover { opacity: 0.9; }
        .gantt-bar.resource { background: linear-gradient(135deg, var(--primary-blue), #3b82f6); }
        .gantt-bar.contract { background: linear-gradient(135deg, var(--success), #34d399); }
        .gantt-bar.tbh { background: linear-gradient(135deg, var(--danger), #f87171); }
        .gantt-bar.no-dates { background: var(--gray-300); opacity: 0.5; }
        .gantt-legend { display: flex; gap: 20px; padding: 16px; border-top: 1px solid var(--gray-200); }
        .gantt-legend-item { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--gray-600); }
        .gantt-legend-color { width: 16px; height: 16px; border-radius: 4px; }
        .gantt-legend-color.resource { background: var(--primary-blue); }
        .gantt-legend-color.contract { background: var(--success); }
        .gantt-legend-color.tbh { background: var(--danger); }
        .gantt-section-header { padding: 12px 16px; background: var(--gray-50); font-weight: 600; font-size: 13px; color: var(--gray-700); border-bottom: 1px solid var(--gray-200); }

        /* Editable Client Dropdown */
        .editable-client { position: relative; }
        .client-dropdown { padding: 6px 10px; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 13px; background: white; cursor: pointer; min-width: 140px; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2364748b' d='M2 4l4 4 4-4'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 8px center; padding-right: 28px; }
        .client-dropdown:focus { outline: none; border-color: var(--primary-blue); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .client-dropdown:disabled { background: var(--gray-100); cursor: not-allowed; }
        .client-dropdown.saving { opacity: 0.6; }
        .save-indicator { position: absolute; right: -24px; top: 50%; transform: translateY(-50%); }
        .save-indicator.success { color: var(--success); }
        .save-indicator.error { color: var(--danger); }
        .inline-edit-btn { padding: 4px 8px; font-size: 11px; background: var(--gray-100); border: 1px solid var(--gray-200); border-radius: 4px; cursor: pointer; color: var(--gray-600); }
        .inline-edit-btn:hover { background: var(--gray-200); }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading data from ClickUp...</div>
        <div class="error-message" id="errorMessage" style="display: none;"></div>
    </div>

    <div class="dashboard">
        <div class="header">
            <h1>
                <svg width="28" height="28" viewBox="0 0 24 24" fill="white"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
                Service Physics - Resource Dashboard
            </h1>
            <div class="header-meta">
                <div class="sync-status">
                    <div class="sync-dot" id="syncDot"></div>
                    <span id="syncText">Synced with ClickUp</span>
                </div>
                <span class="last-updated">Last updated: <span id="lastUpdated"></span></span>
                <div class="dropdown">
                    <button class="header-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
                        Export
                    </button>
                    <div class="dropdown-content">
                        <a class="dropdown-item" onclick="exportToExcel()">Export to Excel</a>
                        <a class="dropdown-item" onclick="exportToCSV()">Export to CSV</a>
                        <a class="dropdown-item" onclick="window.print()">Print Dashboard</a>
                    </div>
                </div>
                <button class="header-btn primary" onclick="refreshData()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                    </svg>
                    Refresh
                </button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('overview')">Overview</button>
            <button class="tab" onclick="switchTab('alerts')">Alerts</button>
            <button class="tab" onclick="switchTab('clients')">By Client</button>
            <button class="tab" onclick="switchTab('resources')">Resource Capacity</button>
            <button class="tab" onclick="switchTab('contracts')">Contracts</button>
            <button class="tab" onclick="switchTab('pipeline')">Converted vs Funnel</button>
            <button class="tab" onclick="switchTab('salesfunnel')">Sales Pipeline</button>
            <button class="tab" onclick="switchTab('recruitment')">Recruitment</button>
            <button class="tab" onclick="switchTab('timeline')">Timeline</button>
            <button class="tab" onclick="switchTab('team')">Team View</button>
            <button class="tab" onclick="switchTab('gantt')">ðŸ“Š Gantt Chart</button>
        </div>

        <!-- OVERVIEW TAB -->
        <div id="overview" class="tab-content active">
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Active Clients</span>
                        <div class="kpi-icon blue">&#127970;</div>
                    </div>
                    <div class="kpi-value" id="kpi-clients">-</div>
                    <div class="kpi-change neutral"><span>All contracted clients</span></div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Total Allocations</span>
                        <div class="kpi-icon green">&#128101;</div>
                    </div>
                    <div class="kpi-value" id="kpi-allocations">-</div>
                    <div class="kpi-change positive"><span>Across all clients</span></div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Engagement Leads</span>
                        <div class="kpi-icon purple">&#11088;</div>
                    </div>
                    <div class="kpi-value" id="kpi-el">-</div>
                    <div class="kpi-change neutral"><span id="kpi-el-note">Unique ELs</span></div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Project Leads</span>
                        <div class="kpi-icon cyan">&#127919;</div>
                    </div>
                    <div class="kpi-value" id="kpi-pl">-</div>
                    <div class="kpi-change neutral"><span>Delivery execution</span></div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Converted</span>
                        <div class="kpi-icon green">&#9989;</div>
                    </div>
                    <div class="kpi-value" id="kpi-converted">-</div>
                    <div class="kpi-change positive"><span>Fully staffed</span></div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">In Funnel/TBH</span>
                        <div class="kpi-icon orange">&#9203;</div>
                    </div>
                    <div class="kpi-value" id="kpi-funnel">-</div>
                    <div class="kpi-change negative"><span>Needs attention</span></div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Sales Pipeline</span>
                        <div class="kpi-icon purple">&#128200;</div>
                    </div>
                    <div class="kpi-value" id="kpi-pipeline">-</div>
                    <div class="kpi-change neutral"><span>2026 opportunities</span></div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Candidates</span>
                        <div class="kpi-icon cyan">&#128188;</div>
                    </div>
                    <div class="kpi-value" id="kpi-candidates">-</div>
                    <div class="kpi-change neutral"><span>In recruitment</span></div>
                </div>
            </div>

            <!-- MONTH STATUS CARDS -->
            <div class="section-card">
                <div class="section-header">
                    <h3 class="section-title">Monthly Resource Status</h3>
                    <span style="font-size: 13px; color: var(--gray-500);">Current and upcoming months</span>
                </div>
                <div class="month-grid" id="monthStatusGrid">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title">Allocations by Client</h3></div>
                    <div class="chart-container"><canvas id="clientChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title">Role Distribution</h3></div>
                    <div class="chart-container"><canvas id="roleChart"></canvas></div>
                </div>
            </div>

            <div class="section-card">
                <div class="section-header">
                    <h3 class="section-title">All Allocations</h3>
                    <div class="section-actions">
                        <input type="text" class="search-input" placeholder="Search resources, clients..." id="allocationSearch" onkeyup="searchAllocations()">
                        <select id="roleFilter" onchange="filterByRole()">
                            <option value="">All Roles</option>
                            <option value="EL">Engagement Lead</option>
                            <option value="PL">Project Lead</option>
                            <option value="Special">Special Project</option>
                            <option value="TBH">To Be Hired</option>
                        </select>
                    </div>
                </div>
                <div class="table-container">
                    <table id="allocationTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable('resource')">Resource</th>
                                <th onclick="sortTable('client')">Client</th>
                                <th onclick="sortTable('contract')">Contract</th>
                                <th onclick="sortTable('role')">Role</th>
                                <th onclick="sortTable('percent')">Allocation %</th>
                                <th onclick="sortTable('supportingResource')">Supporting</th>
                                <th onclick="sortTable('supportingPrincipal')">Principal</th>
                                <th>Status</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody id="allocationTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ALERTS TAB -->
        <div id="alerts" class="tab-content">
            <div class="section-card">
                <div class="section-header">
                    <h3 class="section-title">Capacity & Resource Alerts</h3>
                    <span style="font-size: 13px; color: var(--gray-500);">Items requiring attention</span>
                </div>
            </div>
            <div class="alerts-container" id="alertsContainer">
                <!-- Alerts will be populated dynamically -->
            </div>
            <div class="section-card">
                <div class="section-header">
                    <h3 class="section-title">Upcoming Capacity Needs (from Sales Pipeline)</h3>
                </div>
                <div id="capacityForecast"></div>
            </div>
        </div>

        <!-- BY CLIENT TAB -->
        <div id="clients" class="tab-content">
            <div class="filters">
                <div class="filter-group">
                    <span class="filter-label">Filter by Client:</span>
                    <select id="clientFilter" onchange="filterClients()">
                        <option value="">All Clients</option>
                    </select>
                </div>
            </div>
            <div id="clientCards"></div>
        </div>

        <!-- RESOURCE CAPACITY TAB -->
        <div id="resources" class="tab-content">
            <div class="section-card">
                <div class="section-header">
                    <h3 class="section-title">Resources with Split Allocations</h3>
                    <span style="font-size: 13px; color: var(--gray-500);">Showing team members working across multiple clients</span>
                </div>
            </div>
            <div class="capacity-grid" id="capacityGrid"></div>

            <div class="section-card">
                <div class="section-header">
                    <h3 class="section-title">Full Capacity View</h3>
                </div>
                <div class="chart-container" style="height: 400px;"><canvas id="capacityChart"></canvas></div>
            </div>
        </div>

        <!-- CONTRACTS TAB -->
        <div id="contracts" class="tab-content">
            <div class="section-card">
                <div class="section-header">
                    <h3 class="section-title">Active Contracts</h3>
                    <span style="font-size: 13px; color: var(--gray-500);" id="contractCount">Loading...</span>
                </div>
            </div>
            <div class="contract-grid" id="contractGrid"></div>
        </div>

        <!-- PIPELINE TAB (Converted vs Funnel) -->
        <div id="pipeline" class="tab-content">
            <div class="charts-grid" style="margin-bottom: 24px;">
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title">Conversion Status</h3></div>
                    <div class="chart-container"><canvas id="conversionChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title">Staffing Gaps by Client</h3></div>
                    <div class="chart-container"><canvas id="gapChart"></canvas></div>
                </div>
            </div>

            <div class="pipeline-container" id="pipelineContainer"></div>
        </div>

        <!-- SALES FUNNEL TAB -->
        <div id="salesfunnel" class="tab-content">
            <div class="kpi-grid" style="margin-bottom: 24px;">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Total Opportunities</span>
                        <div class="kpi-icon blue">&#128200;</div>
                    </div>
                    <div class="kpi-value" id="sales-total">-</div>
                    <div class="kpi-change neutral"><span>In pipeline</span></div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">High Probability (60%+)</span>
                        <div class="kpi-icon green">&#127919;</div>
                    </div>
                    <div class="kpi-value" id="sales-high">-</div>
                    <div class="kpi-change positive"><span>Likely to close</span></div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Medium Probability</span>
                        <div class="kpi-icon orange">&#128293;</div>
                    </div>
                    <div class="kpi-value" id="sales-medium">-</div>
                    <div class="kpi-change neutral"><span>40-59%</span></div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Early Stage</span>
                        <div class="kpi-icon purple">&#127793;</div>
                    </div>
                    <div class="kpi-value" id="sales-early">-</div>
                    <div class="kpi-change neutral"><span>Under 40%</span></div>
                </div>
            </div>

            <div class="charts-grid" style="margin-bottom: 24px;">
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title">Pipeline by Stage</h3></div>
                    <div class="chart-container"><canvas id="salesStageChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title">Opportunities by Client</h3></div>
                    <div class="chart-container"><canvas id="salesClientChart"></canvas></div>
                </div>
            </div>

            <div class="section-card">
                <div class="section-header">
                    <h3 class="section-title">Sales Pipeline</h3>
                    <div class="section-actions">
                        <input type="text" class="search-input" placeholder="Search opportunities..." id="salesSearch" onkeyup="searchSales()">
                        <select id="salesStatusFilter" onchange="filterSales()">
                            <option value="">All Stages</option>
                            <option value="Intro">Intro</option>
                            <option value="Pitch Deck">Pitch Deck</option>
                            <option value="No Fee Proposal">No Fee Proposal</option>
                            <option value="WBS & Proposal">WBS & Proposal</option>
                            <option value="Work Order Created">Work Order Created</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Limbo">Limbo</option>
                        </select>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th onclick="sortSalesTable('client')">Client</th>
                                <th onclick="sortSalesTable('project')">Project</th>
                                <th onclick="sortSalesTable('probability')">Probability</th>
                                <th onclick="sortSalesTable('status')">Status</th>
                            </tr>
                        </thead>
                        <tbody id="salesTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- RECRUITMENT TAB -->
        <div id="recruitment" class="tab-content">
            <div class="kpi-grid" style="margin-bottom: 24px;">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Total Candidates</span>
                        <div class="kpi-icon blue">&#128188;</div>
                    </div>
                    <div class="kpi-value" id="recruit-total">-</div>
                    <div class="kpi-change neutral"><span>In funnel</span></div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Active Interviews</span>
                        <div class="kpi-icon green">&#128483;</div>
                    </div>
                    <div class="kpi-value" id="recruit-interviews">-</div>
                    <div class="kpi-change positive"><span>In progress</span></div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Offers Extended</span>
                        <div class="kpi-icon purple">&#128230;</div>
                    </div>
                    <div class="kpi-value" id="recruit-offers">-</div>
                    <div class="kpi-change neutral"><span>Pending response</span></div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Open Positions</span>
                        <div class="kpi-icon orange">&#9888;</div>
                    </div>
                    <div class="kpi-value" id="recruit-open">-</div>
                    <div class="kpi-change negative"><span>Need to fill</span></div>
                </div>
            </div>

            <div class="section-card">
                <div class="section-header">
                    <h3 class="section-title">Recruitment Pipeline</h3>
                </div>
                <div class="pipeline-container" id="recruitmentPipeline"></div>
            </div>

            <div class="section-card">
                <div class="section-header">
                    <h3 class="section-title">All Candidates</h3>
                    <input type="text" class="search-input" placeholder="Search candidates..." id="candidateSearch" onkeyup="searchCandidates()">
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Candidate</th>
                                <th>Position</th>
                                <th>Stage</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="candidateTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TIMELINE TAB -->
        <div id="timeline" class="tab-content">
            <div class="section-card">
                <div class="section-header">
                    <h3 class="section-title">Resource Transitions & Changes</h3>
                </div>
                <div class="timeline" id="timelineContainer"></div>
            </div>
        </div>

        <!-- TEAM VIEW TAB -->
        <div id="team" class="tab-content">
            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title">Team Utilization by Resource</h3></div>
                    <div class="chart-container"><canvas id="utilizationChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title">Client Coverage</h3></div>
                    <div class="chart-container"><canvas id="coverageChart"></canvas></div>
                </div>
            </div>
            <div class="section-card">
                <div class="section-header">
                    <h3 class="section-title">Full Team Roster</h3>
                    <div class="section-actions">
                        <input type="text" class="search-input" placeholder="Search team..." id="teamSearch" onkeyup="searchTeam()">
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Name</th><th>Primary Client</th><th>Role</th><th>Split With</th><th>Total Allocation</th><th>Status</th></tr></thead>
                        <tbody id="teamTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- GANTT CHART TAB -->
        <div id="gantt" class="tab-content">
            <div class="section-card">
                <div class="section-header">
                    <h3 class="section-title">ðŸ“Š Resource & Contract Timeline</h3>
                    <div class="section-actions">
                        <select id="ganttViewMode" onchange="renderGanttChart()" class="client-dropdown" style="min-width: 120px;">
                            <option value="6">6 Months</option>
                            <option value="12" selected>12 Months</option>
                            <option value="18">18 Months</option>
                        </select>
                        <button class="btn btn-secondary" onclick="renderGanttChart()">ðŸ”„ Refresh</button>
                    </div>
                </div>
                <div class="gantt-container" id="ganttContainer">
                    <!-- Gantt chart will be rendered here -->
                </div>
                <div class="gantt-legend">
                    <div class="gantt-legend-item"><div class="gantt-legend-color resource"></div> Resource Assignment</div>
                    <div class="gantt-legend-item"><div class="gantt-legend-color contract"></div> Client Contract</div>
                    <div class="gantt-legend-item"><div class="gantt-legend-color tbh"></div> To Be Hired</div>
                </div>
            </div>

            <div class="section-card" style="margin-top: 24px;">
                <div class="section-header">
                    <h3 class="section-title">âœï¸ Quick Edit Assignments</h3>
                    <span style="font-size: 13px; color: var(--gray-500);">Change client assignments directly - updates ClickUp automatically</span>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Resource</th>
                                <th>Current Client(s)</th>
                                <th>Change Client</th>
                                <th>Role</th>
                                <th>Allocation %</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="editableAllocationsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Data synced from <a href="https://app.clickup.com/2383252/v/l/6-901112841124-1" target="_blank">ClickUp</a> | Service Physics Resource Management</p>
            <p style="margin-top: 8px; font-size: 11px; color: var(--gray-400);">Dashboard v3.1 | Auto-refreshes every 5 minutes</p>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION - ClickUp API Integration
        // ============================================
        const CONFIG = {
            API_TOKEN: 'pk_75502722_RDEO4WFFSG8XIIRYYJ4VALC0RYIU7VLN',
            ALLOCATIONS_LIST_ID: '901112841124',
            SALES_FUNNEL_LIST_ID: '901112956083',
            RECRUITMENT_LIST_ID: '901104337192',
            REFRESH_INTERVAL: 300000 // 5 minutes
        };

        // ============================================
        // GLOBAL STATE
        // ============================================
        let allocations = [];
        let salesFunnel = [];
        let candidates = [];
        let clients = [];
        let filteredAllocations = [];
        let filteredSales = [];
        let filteredCandidates = [];
        let currentSort = { column: null, asc: true };
        let salesSort = { column: null, asc: true };

        const colors = {
            "Panda": "#2563eb", "Veritas": "#10b981", "Subway": "#f59e0b", "HBH": "#ef4444",
            "Caseys": "#8b5cf6", "Bagel Brands": "#06b6d4", "Cava": "#ec4899", "Cartier": "#f97316",
            "DaVita": "#0ea5e9", "Starbucks": "#059669", "Blaze Pizza": "#dc2626", "Counter Service": "#7c3aed",
            "Great Harvest Bread": "#d97706", "Habit Burger": "#db2777", "Highlands Coffee": "#065f46",
            "HoneyBaked": "#b45309", "Peet's": "#4f46e5", "Smalls Sliders": "#e11d48", "Wendys": "#ea580c",
            "Wonder": "#8b5cf6", "Whataburger": "#f97316", "Vail Resorts": "#0284c7", "Casey's": "#8b5cf6"
        };
        const avatarColors = ["#2563eb", "#10b981", "#f59e0b", "#ef4444", "#8b5cf6", "#06b6d4", "#ec4899", "#f97316"];

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', async function() {
            await loadAllData();
            setInterval(refreshData, CONFIG.REFRESH_INTERVAL);
        });

        async function loadAllData() {
            showLoading(true);
            try {
                // Load all data sources in parallel
                const [allocData, salesData, recruitData] = await Promise.all([
                    fetchClickUpTasks(CONFIG.ALLOCATIONS_LIST_ID),
                    fetchClickUpTasks(CONFIG.SALES_FUNNEL_LIST_ID),
                    fetchClickUpTasks(CONFIG.RECRUITMENT_LIST_ID)
                ]);

                allocations = parseAllocations(allocData);
                salesFunnel = parseSalesFunnel(salesData);
                candidates = parseRecruitment(recruitData);

                filteredAllocations = [...allocations];
                filteredSales = [...salesFunnel];
                filteredCandidates = [...candidates];

                // Extract unique clients
                clients = [...new Set(allocations.map(a => a.client))].sort();

                // Render everything
                renderDashboard();
                updateSyncStatus(true);
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Failed to load data from ClickUp. Please check your API token and list IDs.');
                updateSyncStatus(false);
            }
            showLoading(false);
        }

        async function fetchClickUpTasks(listId) {
            const response = await fetch(`https://api.clickup.com/api/v2/list/${listId}/task?archived=false&include_closed=true`, {
                headers: { 'Authorization': CONFIG.API_TOKEN }
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            return data.tasks || [];
        }

        // ============================================
        // DATA PARSING
        // ============================================
        function parseAllocations(tasks) {
            return tasks.map(task => {
                const fields = {};
                (task.custom_fields || []).forEach(cf => {
                    fields[cf.name] = cf.value !== undefined ? cf.value :
                        (cf.type_config?.options?.find(o => o.orderindex === cf.value)?.name || '');
                });

                // Get client from Contract relationship field
                const clientName = getClientFromContract(task);

                return {
                    id: task.id,
                    resource: task.name || 'Unknown',
                    client: clientName,
                    role: getFieldValue(task, 'Role') || 'PL',
                    percent: parseInt(getFieldValue(task, 'Allocation %') || getFieldValue(task, 'Percent') || '100'),
                    status: mapStatus(task.status?.status || 'active'),
                    notes: getFieldValue(task, 'Notes') || '',
                    contract: clientName, // Contract is the client relationship
                    team: getFieldValue(task, 'Team') || getFieldValue(task, 'Team Name') || '',
                    supportingResource: getFieldValue(task, 'Supporting Resource') || getFieldValue(task, 'Supporting') || '',
                    supportingPrincipal: getFieldValue(task, 'Supporting Principal') || getFieldValue(task, 'Principal') || ''
                };
            });
        }

        function parseSalesFunnel(tasks) {
            return tasks.map(task => {
                return {
                    id: task.id,
                    client: task.name || 'Unknown',
                    project: getFieldValue(task, 'Project') || '',
                    probability: parseInt(getFieldValue(task, 'Probability') || '0'),
                    status: getFieldValue(task, 'Sales Status') || task.status?.status || 'Unknown'
                };
            });
        }

        function parseRecruitment(tasks) {
            return tasks.map(task => {
                return {
                    id: task.id,
                    name: task.name || 'Unknown',
                    position: getFieldValue(task, 'Position') || getFieldValue(task, 'Role') || '',
                    stage: task.status?.status || 'New',
                    notes: getFieldValue(task, 'Notes') || ''
                };
            });
        }

        function getFieldValue(task, fieldName) {
            const field = (task.custom_fields || []).find(cf =>
                cf.name?.toLowerCase() === fieldName.toLowerCase()
            );
            if (!field) return '';

            // Handle list_relationship fields (like Contract which links to clients)
            if (field.type === 'list_relationship' && Array.isArray(field.value)) {
                // Return array of linked task names
                return field.value.map(item => item.name || 'Unknown').join(', ');
            }

            if (field.type === 'drop_down' && field.type_config?.options) {
                const option = field.type_config.options.find(o => o.orderindex === field.value);
                return option?.name || '';
            }
            return field.value?.toString() || '';
        }

        // Get client names from Contract relationship field
        function getClientFromContract(task) {
            const contractField = (task.custom_fields || []).find(cf =>
                cf.name?.toLowerCase() === 'contract'
            );
            if (!contractField || !Array.isArray(contractField.value) || contractField.value.length === 0) {
                return 'Unassigned';
            }
            // Return first client name, or join multiple
            return contractField.value.map(item => item.name || 'Unknown').join(', ');
        }

        function mapStatus(status) {
            const statusLower = status.toLowerCase();
            if (statusLower.includes('convert') || statusLower.includes('active') || statusLower.includes('complete')) return 'converted';
            if (statusLower.includes('funnel') || statusLower.includes('transition')) return 'funnel';
            if (statusLower.includes('tbh') || statusLower.includes('hire')) return 'tbh';
            return 'converted';
        }

        // ============================================
        // RENDERING
        // ============================================
        async function renderDashboard() {
            updateLastUpdated();
            populateFilters();
            renderAllocationTable();
            renderClientCards();
            renderCapacityCards();
            renderContractCards();
            renderPipeline();
            renderSalesFunnel();
            renderRecruitment();
            renderTimeline();
            renderTeamTable();
            renderAlerts();
            renderMonthlyStatus();
            updateKPIs();
            initCharts();

            // Fetch contracts data for Gantt chart and editable allocations
            await fetchContractsData();
            renderGanttChart();
            renderEditableAllocations();
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
        }

        function showError(message) {
            const el = document.getElementById('errorMessage');
            el.textContent = message;
            el.style.display = 'block';
        }

        function updateSyncStatus(success) {
            const dot = document.getElementById('syncDot');
            const text = document.getElementById('syncText');
            dot.classList.toggle('error', !success);
            text.textContent = success ? 'Synced with ClickUp' : 'Sync failed';
        }

        function updateLastUpdated() {
            document.getElementById('lastUpdated').textContent = new Date().toLocaleString('en-US', {
                month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit'
            });
        }

        function updateKPIs() {
            // Get unique resources (fix double-counting)
            const uniqueELs = new Set(allocations.filter(a => a.role === 'EL').map(a => a.resource));
            const uniquePLs = new Set(allocations.filter(a => a.role === 'PL').map(a => a.resource));

            const splitResources = {};
            allocations.forEach(a => {
                if (!splitResources[a.resource]) splitResources[a.resource] = [];
                splitResources[a.resource].push(a);
            });
            const multiClient = Object.entries(splitResources).filter(([k, v]) => v.length > 1);

            document.getElementById('kpi-clients').textContent = clients.length;
            document.getElementById('kpi-allocations').textContent = allocations.length;

            // FIXED: Count unique Engagement Leads, not allocation entries
            document.getElementById('kpi-el').textContent = uniqueELs.size;
            document.getElementById('kpi-el-note').textContent = multiClient.filter(([name, allocs]) =>
                allocs.some(a => a.role === 'EL')
            ).length > 0 ? `${uniqueELs.size} unique (some multi-client)` : 'Unique ELs';

            document.getElementById('kpi-pl').textContent = uniquePLs.size;
            document.getElementById('kpi-converted').textContent = allocations.filter(a => a.status === 'converted').length;
            document.getElementById('kpi-funnel').textContent = allocations.filter(a => a.status === 'funnel' || a.status === 'tbh').length;

            // Sales Pipeline KPIs
            document.getElementById('kpi-pipeline').textContent = salesFunnel.length;

            // Candidates KPIs
            document.getElementById('kpi-candidates').textContent = candidates.length;
        }

        function populateFilters() {
            const clientFilter = document.getElementById('clientFilter');
            clientFilter.innerHTML = '<option value="">All Clients</option>';
            clients.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                clientFilter.appendChild(opt);
            });
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        // ============================================
        // ALLOCATION TABLE
        // ============================================
        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.asc = !currentSort.asc;
            } else {
                currentSort.column = column;
                currentSort.asc = true;
            }
            filteredAllocations.sort((a, b) => {
                let valA = a[column], valB = b[column];
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();
                if (valA < valB) return currentSort.asc ? -1 : 1;
                if (valA > valB) return currentSort.asc ? 1 : -1;
                return 0;
            });
            renderAllocationTable(filteredAllocations);
        }

        function searchAllocations() {
            const q = document.getElementById('allocationSearch').value.toLowerCase();
            const roleFilter = document.getElementById('roleFilter').value;
            filteredAllocations = allocations.filter(a => {
                const matchesSearch = a.resource.toLowerCase().includes(q) ||
                    a.client.toLowerCase().includes(q) ||
                    a.role.toLowerCase().includes(q);
                const matchesRole = !roleFilter || a.role === roleFilter;
                return matchesSearch && matchesRole;
            });
            renderAllocationTable(filteredAllocations);
        }

        function filterByRole() { searchAllocations(); }

        function filterClients() {
            const filter = document.getElementById('clientFilter').value;
            renderClientCards(filter);
        }

        function renderAllocationTable(data = allocations) {
            document.getElementById('allocationTableBody').innerHTML = data.map(a => `
                <tr>
                    <td><strong>${a.resource}</strong></td>
                    <td><span style="color: ${colors[a.client] || '#6b7280'}; font-weight: 500;">${a.client}</span></td>
                    <td style="font-size: 12px;">${a.contract || 'â€”'}</td>
                    <td><span class="resource-type-badge ${a.role.toLowerCase()}">${getRoleLabel(a.role)}</span></td>
                    <td>${a.percent}%</td>
                    <td style="font-size: 12px;">${a.supportingResource || 'â€”'}</td>
                    <td style="font-size: 12px;">${a.supportingPrincipal || 'â€”'}</td>
                    <td><span class="status-badge ${a.status}">${getStatusLabel(a.status)}</span></td>
                    <td style="color: var(--gray-500); font-size: 12px;">${a.notes || 'â€”'}</td>
                </tr>
            `).join('');
        }

        function getRoleLabel(role) {
            const labels = { 'EL': 'Engagement Lead', 'PL': 'Project Lead', 'Special': 'Special Project', 'TBH': 'To Be Hired' };
            return labels[role] || role;
        }

        function getStatusLabel(status) {
            const labels = { 'converted': 'Active', 'funnel': 'In Transition', 'tbh': 'To Be Hired' };
            return labels[status] || status;
        }

        // ============================================
        // CLIENT CARDS
        // ============================================
        function renderClientCards(filter = '') {
            const filteredClients = filter ? [filter] : clients;
            document.getElementById('clientCards').innerHTML = filteredClients.map(client => {
                const clientAllocs = allocations.filter(a => a.client === client);
                const el = clientAllocs.find(a => a.role === 'EL');
                const pls = clientAllocs.filter(a => a.role === 'PL');
                const specials = clientAllocs.filter(a => a.role === 'Special');
                const tbh = clientAllocs.filter(a => a.role === 'TBH');
                const totalFTE = clientAllocs.reduce((sum, a) => sum + (a.percent / 100), 0).toFixed(1);
                const color = colors[client] || '#6b7280';

                return `
                <div class="client-card" style="border-left-color: ${color}">
                    <div class="client-header">
                        <div class="client-name" style="color: ${color}">${client}</div>
                        <div class="client-stats">
                            <div class="client-stat"><div class="client-stat-value">${clientAllocs.length}</div><div class="client-stat-label">Team Size</div></div>
                            <div class="client-stat"><div class="client-stat-value">${totalFTE}</div><div class="client-stat-label">FTE</div></div>
                            <div class="client-stat"><div class="client-stat-value">${pls.length}</div><div class="client-stat-label">Project Leads</div></div>
                        </div>
                    </div>
                    <div class="team-list">
                        ${el ? `<div class="team-member"><div class="team-member-avatar" style="background: ${color}">${el.resource.slice(0,2).toUpperCase()}</div><div class="team-member-info"><div class="team-member-name">${el.resource}</div><div class="team-member-role">Engagement Lead${el.percent < 100 ? ` (${el.percent}%)` : ''}</div></div></div>` : ''}
                        ${pls.map(p => `<div class="team-member"><div class="team-member-avatar" style="background: ${color}99">${p.resource.slice(0,2).toUpperCase()}</div><div class="team-member-info"><div class="team-member-name">${p.resource}</div><div class="team-member-role">Project Lead${p.percent < 100 ? ` (${p.percent}%)` : ''}${p.notes ? ` | ${p.notes}` : ''}</div></div></div>`).join('')}
                        ${specials.map(s => `<div class="team-member"><div class="team-member-avatar" style="background: #8b5cf6">${s.resource.slice(0,2).toUpperCase()}</div><div class="team-member-info"><div class="team-member-name">${s.resource}</div><div class="team-member-role">Special Project</div></div></div>`).join('')}
                        ${tbh.map(t => `<div class="team-member"><div class="team-member-avatar" style="background: #ef4444">${t.resource.slice(0,2).toUpperCase()}</div><div class="team-member-info"><div class="team-member-name">${t.resource}</div><div class="team-member-role">To Be Hired</div></div></div>`).join('')}
                    </div>
                </div>
            `}).join('');
        }

        // ============================================
        // CAPACITY VIEW
        // ============================================
        function renderCapacityCards() {
            const splitResources = {};
            allocations.forEach(a => {
                if (!splitResources[a.resource]) splitResources[a.resource] = [];
                splitResources[a.resource].push(a);
            });
            const multiClient = Object.entries(splitResources).filter(([k, v]) => v.length > 1);

            document.getElementById('capacityGrid').innerHTML = multiClient.map(([name, allocs], idx) => {
                const total = allocs.reduce((sum, a) => sum + a.percent, 0);
                const isOverallocated = total > 100;
                return `
                <div class="resource-card">
                    <div class="resource-header">
                        <div class="avatar" style="background: ${avatarColors[idx % avatarColors.length]}">${name.slice(0,2).toUpperCase()}</div>
                        <div class="resource-info">
                            <div class="resource-name">${name}</div>
                            <div class="resource-meta">
                                ${allocs.map(a => `<span class="resource-type-badge ${a.role.toLowerCase()}">${a.role}</span>`).join('')}
                            </div>
                        </div>
                        <div class="total-allocation">
                            <div class="allocation-percent" style="color: ${isOverallocated ? 'var(--danger)' : 'var(--gray-900)'}">${total}%</div>
                            <div class="allocation-label">${isOverallocated ? 'Over' : 'Total'}</div>
                        </div>
                    </div>
                    <div class="project-allocations">
                        ${allocs.map(a => `
                            <div class="project-row">
                                <div class="project-name">${a.client}</div>
                                <div class="allocation-bar">
                                    <div class="allocation-fill" style="width: ${a.percent}%; background: ${colors[a.client] || '#6b7280'}">${a.percent}%</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `}).join('');
        }

        // ============================================
        // CONTRACT CARDS
        // ============================================
        function renderContractCards() {
            document.getElementById('contractCount').textContent = `${clients.length} active client engagements`;
            document.getElementById('contractGrid').innerHTML = clients.map(client => {
                const clientAllocs = allocations.filter(a => a.client === client);
                const el = clientAllocs.find(a => a.role === 'EL');
                const totalFTE = clientAllocs.reduce((sum, a) => sum + (a.percent / 100), 0).toFixed(1);
                const contract = clientAllocs[0]?.contract || client;

                return `
                <div class="contract-card" style="border-top-color: ${colors[client] || '#6b7280'}">
                    <div class="contract-name">${contract}</div>
                    <div class="contract-detail"><span class="contract-label">Client</span><span class="contract-value" style="color: ${colors[client] || '#6b7280'}">${client}</span></div>
                    <div class="contract-detail"><span class="contract-label">Engagement Lead</span><span class="contract-value">${el?.resource || 'TBD'}</span></div>
                    <div class="contract-detail"><span class="contract-label">Team Size</span><span class="contract-value">${clientAllocs.length} members</span></div>
                    <div class="contract-detail"><span class="contract-label">FTE Allocated</span><span class="contract-value">${totalFTE}</span></div>
                    <div class="contract-detail"><span class="contract-label">Status</span><span class="contract-value"><span class="status-badge converted">Active</span></span></div>
                </div>
            `}).join('');
        }

        // ============================================
        // PIPELINE (Converted vs Funnel)
        // ============================================
        function renderPipeline() {
            const converted = allocations.filter(a => a.status === 'converted');
            const funnel = allocations.filter(a => a.status === 'funnel');
            const tbh = allocations.filter(a => a.status === 'tbh');

            document.getElementById('pipelineContainer').innerHTML = `
                <div class="pipeline-stage">
                    <div class="pipeline-header converted">
                        <span class="pipeline-title">Converted / Active</span>
                        <span class="pipeline-count converted">${converted.length}</span>
                    </div>
                    ${converted.slice(0, 8).map(a => `
                        <div class="pipeline-item">
                            <div class="pipeline-item-name">${a.resource}</div>
                            <div class="pipeline-item-meta">${a.role} | ${a.client} | ${a.percent}%</div>
                        </div>
                    `).join('')}
                    ${converted.length > 8 ? `<div style="text-align: center; color: var(--gray-500); font-size: 12px; padding: 8px;">+${converted.length - 8} more</div>` : ''}
                </div>
                <div class="pipeline-stage">
                    <div class="pipeline-header funnel">
                        <span class="pipeline-title">In Transition / Funnel</span>
                        <span class="pipeline-count funnel">${funnel.length}</span>
                    </div>
                    ${funnel.map(a => `
                        <div class="pipeline-item">
                            <div class="pipeline-item-name">${a.resource}</div>
                            <div class="pipeline-item-meta">${a.role} | ${a.client} | ${a.notes}</div>
                        </div>
                    `).join('')}
                    ${funnel.length === 0 ? '<div style="text-align: center; color: var(--gray-400); font-size: 13px; padding: 20px;">No transitions in progress</div>' : ''}
                </div>
                <div class="pipeline-stage">
                    <div class="pipeline-header tbh">
                        <span class="pipeline-title">To Be Hired</span>
                        <span class="pipeline-count tbh">${tbh.length}</span>
                    </div>
                    ${tbh.map(a => `
                        <div class="pipeline-item">
                            <div class="pipeline-item-name">${a.resource}</div>
                            <div class="pipeline-item-meta">${a.role} | ${a.client} | ${a.notes}</div>
                        </div>
                    `).join('')}
                    ${tbh.length === 0 ? '<div style="text-align: center; color: var(--gray-400); font-size: 13px; padding: 20px;">All positions filled!</div>' : ''}
                </div>
            `;
        }

        // ============================================
        // SALES FUNNEL
        // ============================================
        function renderSalesFunnel() {
            const highProb = salesFunnel.filter(s => s.probability >= 60);
            const medProb = salesFunnel.filter(s => s.probability >= 40 && s.probability < 60);
            const lowProb = salesFunnel.filter(s => s.probability < 40);

            document.getElementById('sales-total').textContent = salesFunnel.length;
            document.getElementById('sales-high').textContent = highProb.length;
            document.getElementById('sales-medium').textContent = medProb.length;
            document.getElementById('sales-early').textContent = lowProb.length;

            renderSalesTable(filteredSales);
        }

        function renderSalesTable(data = salesFunnel) {
            document.getElementById('salesTableBody').innerHTML = data.map(s => {
                const probColor = s.probability >= 60 ? 'var(--success)' :
                                  s.probability >= 40 ? 'var(--warning)' : 'var(--gray-500)';
                return `
                <tr>
                    <td><strong style="color: ${colors[s.client] || '#6b7280'}">${s.client}</strong></td>
                    <td>${s.project || 'â€”'}</td>
                    <td><span style="color: ${probColor}; font-weight: 600;">${s.probability}%</span></td>
                    <td><span class="status-badge" style="background: var(--gray-100); color: var(--gray-700);">${s.status}</span></td>
                </tr>
            `}).join('');
        }

        function searchSales() {
            const q = document.getElementById('salesSearch').value.toLowerCase();
            const statusFilter = document.getElementById('salesStatusFilter').value;
            filteredSales = salesFunnel.filter(s => {
                const matchesSearch = s.client.toLowerCase().includes(q) ||
                    (s.project || '').toLowerCase().includes(q);
                const matchesStatus = !statusFilter || s.status === statusFilter;
                return matchesSearch && matchesStatus;
            });
            renderSalesTable(filteredSales);
        }

        function filterSales() { searchSales(); }

        function sortSalesTable(column) {
            if (salesSort.column === column) {
                salesSort.asc = !salesSort.asc;
            } else {
                salesSort.column = column;
                salesSort.asc = true;
            }
            filteredSales.sort((a, b) => {
                let valA = a[column], valB = b[column];
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();
                if (valA < valB) return salesSort.asc ? -1 : 1;
                if (valA > valB) return salesSort.asc ? 1 : -1;
                return 0;
            });
            renderSalesTable(filteredSales);
        }

        // ============================================
        // RECRUITMENT
        // ============================================
        function renderRecruitment() {
            // Group by stage
            const stages = {};
            candidates.forEach(c => {
                if (!stages[c.stage]) stages[c.stage] = [];
                stages[c.stage].push(c);
            });

            // KPIs
            document.getElementById('recruit-total').textContent = candidates.length;
            document.getElementById('recruit-interviews').textContent =
                (stages['Interview'] || []).length + (stages['Technical'] || []).length;
            document.getElementById('recruit-offers').textContent =
                (stages['Offer'] || []).length;
            document.getElementById('recruit-open').textContent =
                allocations.filter(a => a.status === 'tbh').length;

            // Pipeline view
            const stageOrder = ['New', 'Screening', 'Interview', 'Technical', 'Offer', 'Hired', 'Rejected'];
            const stageColors = {
                'New': '#94a3b8', 'Screening': '#8b5cf6', 'Interview': '#f59e0b',
                'Technical': '#06b6d4', 'Offer': '#10b981', 'Hired': '#059669', 'Rejected': '#ef4444'
            };

            document.getElementById('recruitmentPipeline').innerHTML = stageOrder
                .filter(stage => stages[stage]?.length > 0)
                .map(stage => `
                    <div class="pipeline-stage">
                        <div class="pipeline-header" style="border-color: ${stageColors[stage] || '#94a3b8'}">
                            <span class="pipeline-title">${stage}</span>
                            <span class="pipeline-count" style="color: ${stageColors[stage] || '#94a3b8'}">${stages[stage].length}</span>
                        </div>
                        ${stages[stage].map(c => `
                            <div class="candidate-card" style="border-left-color: ${stageColors[stage] || '#94a3b8'}">
                                <div class="candidate-name">${c.name}</div>
                                <div class="candidate-position">${c.position || 'Position TBD'}</div>
                            </div>
                        `).join('')}
                    </div>
                `).join('') || '<p style="color: var(--gray-500); text-align: center; padding: 40px;">No candidates in pipeline</p>';

            // Table
            renderCandidateTable(filteredCandidates);
        }

        function renderCandidateTable(data = candidates) {
            document.getElementById('candidateTableBody').innerHTML = data.map(c => `
                <tr>
                    <td><strong>${c.name}</strong></td>
                    <td>${c.position || 'â€”'}</td>
                    <td><span class="candidate-stage">${c.stage}</span></td>
                    <td>${c.notes || 'â€”'}</td>
                </tr>
            `).join('');
        }

        function searchCandidates() {
            const q = document.getElementById('candidateSearch').value.toLowerCase();
            filteredCandidates = candidates.filter(c =>
                c.name.toLowerCase().includes(q) ||
                (c.position || '').toLowerCase().includes(q)
            );
            renderCandidateTable(filteredCandidates);
        }

        // ============================================
        // MONTHLY STATUS
        // ============================================
        function renderMonthlyStatus() {
            const now = new Date();
            const months = [];
            const monthIcons = ['ðŸ“…', 'ðŸ“Š', 'ðŸ“ˆ'];
            const monthIconClasses = ['jan', 'feb', 'mar', 'apr'];

            // Get current month and next 2 months
            for (let i = 0; i < 3; i++) {
                const date = new Date(now.getFullYear(), now.getMonth() + i, 1);
                months.push({
                    name: date.toLocaleString('en-US', { month: 'long' }),
                    year: date.getFullYear(),
                    shortName: date.toLocaleString('en-US', { month: 'short' }).toLowerCase(),
                    isCurrent: i === 0,
                    monthIndex: i
                });
            }

            const container = document.getElementById('monthStatusGrid');
            if (!container) return;

            container.innerHTML = months.map((month, idx) => {
                // Get actual resource counts by status
                const activeResources = allocations.filter(a => a.status === 'converted');
                const tbhResources = allocations.filter(a => a.status === 'tbh');
                const funnelResources = allocations.filter(a => a.status === 'funnel');

                const totalPositions = allocations.length;
                const staffedCount = activeResources.length;
                const tbhCount = tbhResources.length;
                const funnelCount = funnelResources.length;

                // Get role breakdowns
                const elResources = allocations.filter(a => a.role === 'EL');
                const plResources = allocations.filter(a => a.role === 'PL');
                const specialResources = allocations.filter(a => a.role === 'Special');

                const elStaffed = elResources.filter(a => a.status === 'converted').length;
                const plStaffed = plResources.filter(a => a.status === 'converted').length;

                // Calculate staffing health percentage
                const healthPercent = totalPositions > 0 ? Math.round((staffedCount / totalPositions) * 100) : 100;
                let healthColor = 'green';
                if (healthPercent < 70) healthColor = 'red';
                else if (healthPercent < 90) healthColor = 'orange';

                // Get top resources for this month (sorted by allocation %)
                const topResources = activeResources
                    .sort((a, b) => (b.percent || 100) - (a.percent || 100))
                    .slice(0, 4);

                // Get resources needing attention (TBH or Funnel)
                const needsAttention = [...tbhResources, ...funnelResources].slice(0, 3);

                // Client breakdown with status
                const clientBreakdown = clients.map(c => {
                    const clientAllocs = allocations.filter(a => a.client === c);
                    const clientStaffed = clientAllocs.filter(a => a.status === 'converted').length;
                    const clientTBH = clientAllocs.filter(a => a.status === 'tbh').length;
                    const clientFunnel = clientAllocs.filter(a => a.status === 'funnel').length;
                    const hasEL = clientAllocs.some(a => a.role === 'EL' && a.status === 'converted');

                    let status = 'green';
                    if (clientTBH > 0) status = 'red';
                    else if (clientFunnel > 0 || !hasEL) status = 'orange';

                    return {
                        name: c !== 'Unknown' ? c : 'Client ' + (clients.indexOf(c) + 1),
                        total: clientAllocs.length,
                        staffed: clientStaffed,
                        tbh: clientTBH,
                        funnel: clientFunnel,
                        status: status,
                        hasEL: hasEL
                    };
                }).sort((a, b) => {
                    // Sort: red first, then orange, then green
                    const order = { red: 0, orange: 1, green: 2 };
                    return order[a.status] - order[b.status];
                });

                // Get initials helper
                const getInitials = (name) => {
                    if (!name || name === 'Unknown') return '?';
                    return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                };

                return `
                    <div class="month-card ${month.isCurrent ? 'current' : ''}">
                        <div class="month-card-header">
                            <div class="month-title-area">
                                <div class="month-icon ${month.isCurrent ? 'current' : month.shortName}">${monthIcons[idx]}</div>
                                <div>
                                    <div class="month-name">${month.name}</div>
                                    <div class="month-year">${month.year}</div>
                                </div>
                            </div>
                            <span class="month-badge ${month.isCurrent ? 'current' : 'upcoming'}">${month.isCurrent ? 'Current' : '+' + idx + ' mo'}</span>
                        </div>

                        <div class="month-kpis">
                            <div class="month-kpi">
                                <div class="month-kpi-value success">${staffedCount}</div>
                                <div class="month-kpi-label">Active</div>
                                <div class="month-kpi-sub">of ${totalPositions} positions</div>
                            </div>
                            <div class="month-kpi">
                                <div class="month-kpi-value ${tbhCount > 0 ? 'danger' : ''}">${tbhCount}</div>
                                <div class="month-kpi-label">To Hire</div>
                                <div class="month-kpi-sub">open positions</div>
                            </div>
                            <div class="month-kpi">
                                <div class="month-kpi-value">${elResources.length}</div>
                                <div class="month-kpi-label">EL Roles</div>
                                <div class="month-kpi-sub">${elStaffed} staffed</div>
                            </div>
                            <div class="month-kpi">
                                <div class="month-kpi-value">${plResources.length}</div>
                                <div class="month-kpi-label">PL Roles</div>
                                <div class="month-kpi-sub">${plStaffed} staffed</div>
                            </div>
                        </div>

                        <div class="month-details">
                            ${needsAttention.length > 0 ? `
                            <div class="detail-section">
                                <div class="detail-header">
                                    <span class="detail-title">âš ï¸ Needs Attention</span>
                                    <span class="detail-count">${needsAttention.length} positions</span>
                                </div>
                                <div class="resource-list">
                                    ${needsAttention.map(r => `
                                        <div class="resource-item">
                                            <div class="resource-avatar ${r.status === 'tbh' ? 'tbh' : 'special'}">${getInitials(r.resource)}</div>
                                            <div class="resource-info">
                                                <div class="resource-name">${r.resource !== 'Unknown' ? r.resource : r.role + ' Position'}</div>
                                                <div class="resource-meta">
                                                    <span>${r.client !== 'Unknown' ? r.client : 'Unassigned'}</span>
                                                    <span>â€¢</span>
                                                    <span>${r.role}</span>
                                                </div>
                                            </div>
                                            <span class="resource-status ${r.status}">${r.status === 'tbh' ? 'TO HIRE' : 'TRANSITION'}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            ` : ''}

                            <div class="detail-section">
                                <div class="detail-header">
                                    <span class="detail-title">ðŸ‘¥ Client Coverage</span>
                                    <span class="detail-count">${clients.length} clients</span>
                                </div>
                                <div class="client-tags">
                                    ${clientBreakdown.slice(0, 6).map(c => `
                                        <div class="client-tag">
                                            <span class="tag-dot ${c.status}"></span>
                                            <span>${c.name}</span>
                                            <span style="color: var(--gray-400);">(${c.staffed}/${c.total})</span>
                                        </div>
                                    `).join('')}
                                    ${clientBreakdown.length > 6 ? `<div class="client-tag">+${clientBreakdown.length - 6} more</div>` : ''}
                                </div>
                            </div>

                            ${topResources.length > 0 ? `
                            <div class="detail-section">
                                <div class="detail-header">
                                    <span class="detail-title">ðŸŒŸ Top Resources</span>
                                    <span class="detail-count">By allocation</span>
                                </div>
                                <div class="resource-list">
                                    ${topResources.map(r => `
                                        <div class="resource-item">
                                            <div class="resource-avatar ${r.role === 'EL' ? 'el' : (r.role === 'PL' ? 'pl' : 'special')}">${getInitials(r.resource)}</div>
                                            <div class="resource-info">
                                                <div class="resource-name">${r.resource !== 'Unknown' ? r.resource : 'Resource'}</div>
                                                <div class="resource-meta">
                                                    <span>${r.client !== 'Unknown' ? r.client : 'â€”'}</span>
                                                    <span>â€¢</span>
                                                    <span>${r.role}</span>
                                                    <span>â€¢</span>
                                                    <span>${r.percent || 100}%</span>
                                                </div>
                                            </div>
                                            <span class="resource-status active">ACTIVE</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            ` : ''}
                        </div>

                        <div class="month-footer">
                            <div class="health-indicator">
                                <div class="health-bar">
                                    <div class="health-fill ${healthColor}" style="width: ${healthPercent}%"></div>
                                </div>
                                <span class="health-text ${healthColor}">${healthPercent}% Staffed</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // GANTT CHART
        // ============================================
        let contractsData = []; // Store fetched contracts data

        async function fetchContractsData() {
            try {
                // Get all unique contract IDs from allocations
                const contractIds = new Set();
                allocations.forEach(a => {
                    // Find contract field in raw task data (we'll need to re-fetch)
                });

                // Fetch allocations with full data to get contract relationships
                const response = await fetch(`https://api.clickup.com/api/v2/list/${CONFIG.ALLOCATIONS_LIST_ID}/task?archived=false&include_closed=true`, {
                    headers: { 'Authorization': CONFIG.API_TOKEN }
                });
                const data = await response.json();

                // Extract unique contract task IDs
                const contractTaskIds = new Set();
                data.tasks.forEach(task => {
                    const contractField = (task.custom_fields || []).find(cf => cf.name === 'Contract');
                    if (contractField && Array.isArray(contractField.value)) {
                        contractField.value.forEach(c => contractTaskIds.add(c.id));
                    }
                });

                // Fetch each contract to get dates
                contractsData = [];
                for (const id of Array.from(contractTaskIds)) {
                    try {
                        const contractResponse = await fetch(`https://api.clickup.com/api/v2/task/${id}`, {
                            headers: { 'Authorization': CONFIG.API_TOKEN }
                        });
                        const contractTask = await contractResponse.json();

                        const startDateField = (contractTask.custom_fields || []).find(cf => cf.name === 'Contract Start Date');
                        const endDateField = (contractTask.custom_fields || []).find(cf => cf.name === 'Contract End Date');

                        contractsData.push({
                            id: contractTask.id,
                            name: contractTask.name,
                            startDate: startDateField?.value ? new Date(parseInt(startDateField.value)) : null,
                            endDate: endDateField?.value ? new Date(parseInt(endDateField.value)) : null
                        });
                    } catch (e) {
                        console.error('Error fetching contract:', id, e);
                    }
                }

                return contractsData;
            } catch (e) {
                console.error('Error fetching contracts data:', e);
                return [];
            }
        }

        function renderGanttChart() {
            const container = document.getElementById('ganttContainer');
            if (!container) return;

            const monthsToShow = parseInt(document.getElementById('ganttViewMode')?.value || '12');
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            // Generate months array
            const months = [];
            for (let i = 0; i < monthsToShow; i++) {
                const date = new Date(currentYear, currentMonth + i, 1);
                months.push({
                    label: date.toLocaleString('en-US', { month: 'short', year: '2-digit' }),
                    date: date,
                    isCurrent: i === 0
                });
            }

            // Build header
            let html = `
                <div class="gantt-header">
                    <div class="gantt-label-col">Resource / Contract</div>
                    <div class="gantt-timeline">
                        ${months.map(m => `<div class="gantt-month ${m.isCurrent ? 'current' : ''}">${m.label}</div>`).join('')}
                    </div>
                </div>
                <div class="gantt-body">
            `;

            // Add contract section
            html += `<div class="gantt-section-header">ðŸ“‹ Client Contracts</div>`;
            if (contractsData.length === 0) {
                html += `<div class="gantt-row"><div class="gantt-row-label"><span class="gantt-row-name" style="color: var(--gray-400);">Loading contracts...</span></div><div class="gantt-row-timeline">${months.map(() => `<div class="gantt-cell"></div>`).join('')}</div></div>`;
            } else {
                contractsData.forEach(contract => {
                    const barStyle = calculateBarPosition(contract.startDate, contract.endDate, months);
                    html += `
                        <div class="gantt-row">
                            <div class="gantt-row-label">
                                <div>
                                    <div class="gantt-row-name">${contract.name}</div>
                                    <div class="gantt-row-meta">${contract.startDate ? formatDate(contract.startDate) + ' - ' + (contract.endDate ? formatDate(contract.endDate) : 'Ongoing') : 'No dates set'}</div>
                                </div>
                            </div>
                            <div class="gantt-row-timeline">
                                ${months.map(() => `<div class="gantt-cell"></div>`).join('')}
                                ${barStyle ? `<div class="gantt-bar contract" style="${barStyle}" title="${contract.name}">${contract.name}</div>` : `<div class="gantt-bar no-dates" style="left: 5%; width: 90%;">No dates set</div>`}
                            </div>
                        </div>
                    `;
                });
            }

            // Add resources section
            html += `<div class="gantt-section-header">ðŸ‘¥ Resource Assignments</div>`;
            allocations.forEach(alloc => {
                const barClass = alloc.status === 'tbh' ? 'tbh' : 'resource';
                // For now, show full bar since individual resource dates aren't set
                html += `
                    <div class="gantt-row">
                        <div class="gantt-row-label">
                            <div>
                                <div class="gantt-row-name">${alloc.resource}</div>
                                <div class="gantt-row-meta">${alloc.client} â€¢ ${alloc.role} â€¢ ${alloc.percent}%</div>
                            </div>
                        </div>
                        <div class="gantt-row-timeline">
                            ${months.map(() => `<div class="gantt-cell"></div>`).join('')}
                            <div class="gantt-bar ${barClass}" style="left: 2%; width: 96%;" title="${alloc.resource} - ${alloc.client}">${alloc.client}</div>
                        </div>
                    </div>
                `;
            });

            html += `</div>`;
            container.innerHTML = html;
        }

        function calculateBarPosition(startDate, endDate, months) {
            if (!startDate && !endDate) return null;

            const timelineStart = months[0].date.getTime();
            const timelineEnd = new Date(months[months.length - 1].date.getFullYear(), months[months.length - 1].date.getMonth() + 1, 0).getTime();
            const totalDuration = timelineEnd - timelineStart;

            const barStart = startDate ? Math.max(startDate.getTime(), timelineStart) : timelineStart;
            const barEnd = endDate ? Math.min(endDate.getTime(), timelineEnd) : timelineEnd;

            if (barStart > timelineEnd || barEnd < timelineStart) return null;

            const leftPercent = ((barStart - timelineStart) / totalDuration) * 100;
            const widthPercent = ((barEnd - barStart) / totalDuration) * 100;

            return `left: ${leftPercent}%; width: ${Math.max(widthPercent, 2)}%;`;
        }

        function formatDate(date) {
            if (!date) return '';
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' });
        }

        // ============================================
        // EDITABLE ALLOCATIONS
        // ============================================
        function renderEditableAllocations() {
            const tbody = document.getElementById('editableAllocationsBody');
            if (!tbody) return;

            // Get unique clients for dropdown
            const availableClients = [...new Set(contractsData.map(c => c.name))].sort();

            tbody.innerHTML = allocations.map(alloc => `
                <tr>
                    <td><strong>${alloc.resource}</strong></td>
                    <td>${alloc.client}</td>
                    <td>
                        <div class="editable-client">
                            <select class="client-dropdown" onchange="updateClientAssignment('${alloc.id}', this.value, this)" ${availableClients.length === 0 ? 'disabled' : ''}>
                                <option value="">-- Select Client --</option>
                                ${availableClients.map(c => `<option value="${c}" ${alloc.client.includes(c) ? 'selected' : ''}>${c}</option>`).join('')}
                            </select>
                            <span class="save-indicator" id="indicator-${alloc.id}"></span>
                        </div>
                    </td>
                    <td><span class="resource-type-badge ${alloc.role.toLowerCase()}">${alloc.role}</span></td>
                    <td>${alloc.percent}%</td>
                    <td><span class="status-badge ${alloc.status}">${alloc.status}</span></td>
                </tr>
            `).join('');
        }

        async function updateClientAssignment(taskId, newClientName, selectElement) {
            const indicator = document.getElementById(`indicator-${taskId}`);
            selectElement.classList.add('saving');
            selectElement.disabled = true;

            try {
                // Find the contract ID for the selected client name
                const contract = contractsData.find(c => c.name === newClientName);
                if (!contract) {
                    throw new Error('Client not found');
                }

                // Update the task in ClickUp
                // Note: Updating list_relationship fields requires special API handling
                const response = await fetch(`https://api.clickup.com/api/v2/task/${taskId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': CONFIG.API_TOKEN,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        // For list_relationship, we need to use the field ID
                        // This is a simplified version - full implementation would need field ID lookup
                    })
                });

                if (!response.ok) throw new Error('Failed to update');

                indicator.innerHTML = 'âœ“';
                indicator.className = 'save-indicator success';

                // Update local data
                const alloc = allocations.find(a => a.id === taskId);
                if (alloc) {
                    alloc.client = newClientName;
                    alloc.contract = newClientName;
                }

                setTimeout(() => {
                    indicator.innerHTML = '';
                    indicator.className = 'save-indicator';
                }, 2000);

            } catch (error) {
                console.error('Error updating assignment:', error);
                indicator.innerHTML = 'âœ—';
                indicator.className = 'save-indicator error';

                setTimeout(() => {
                    indicator.innerHTML = '';
                    indicator.className = 'save-indicator';
                }, 3000);
            } finally {
                selectElement.classList.remove('saving');
                selectElement.disabled = false;
            }
        }

        // ============================================
        // ALERTS
        // ============================================
        function renderAlerts() {
            const alerts = [];

            // Alert: Positions to be hired
            const tbhPositions = allocations.filter(a => a.status === 'tbh');
            if (tbhPositions.length > 0) {
                alerts.push({
                    type: 'danger',
                    icon: '&#9888;',
                    title: `${tbhPositions.length} Position(s) To Be Hired`,
                    desc: tbhPositions.map(p => `${p.client}: ${p.resource || 'Open Position'}`).join(', '),
                    action: 'View recruitment pipeline'
                });
            }

            // Alert: Resources in transition
            const transitions = allocations.filter(a => a.status === 'funnel');
            if (transitions.length > 0) {
                alerts.push({
                    type: 'warning',
                    icon: '&#128260;',
                    title: `${transitions.length} Resource(s) In Transition`,
                    desc: transitions.map(t => `${t.resource} moving to ${t.client}`).join(', '),
                    action: 'View timeline'
                });
            }

            // Alert: Over-allocated resources
            const resourceAllocs = {};
            allocations.forEach(a => {
                if (!resourceAllocs[a.resource]) resourceAllocs[a.resource] = 0;
                resourceAllocs[a.resource] += a.percent;
            });
            const overAllocated = Object.entries(resourceAllocs).filter(([_, total]) => total > 100);
            if (overAllocated.length > 0) {
                alerts.push({
                    type: 'danger',
                    icon: '&#128680;',
                    title: `${overAllocated.length} Over-Allocated Resource(s)`,
                    desc: overAllocated.map(([name, total]) => `${name}: ${total}%`).join(', '),
                    action: 'View resource capacity'
                });
            }

            // Alert: High probability sales opportunities
            const highProbSales = salesFunnel.filter(s => s.probability >= 60 && s.status !== 'In Progress' && s.status !== 'Work Order Created');
            if (highProbSales.length > 0) {
                alerts.push({
                    type: 'info',
                    icon: '&#128200;',
                    title: `${highProbSales.length} High-Probability Opportunity(ies) in Pipeline`,
                    desc: `Plan capacity for: ${highProbSales.slice(0, 3).map(s => s.client).join(', ')}${highProbSales.length > 3 ? '...' : ''}`,
                    action: 'View sales pipeline'
                });
            }

            // Alert: Clients without EL
            const clientsWithEL = new Set(allocations.filter(a => a.role === 'EL').map(a => a.client));
            const clientsWithoutEL = clients.filter(c => !clientsWithEL.has(c));
            if (clientsWithoutEL.length > 0) {
                alerts.push({
                    type: 'warning',
                    icon: '&#9734;',
                    title: `${clientsWithoutEL.length} Client(s) Without Assigned EL`,
                    desc: clientsWithoutEL.join(', '),
                    action: 'Assign engagement leads'
                });
            }

            // Render alerts
            const container = document.getElementById('alertsContainer');
            if (alerts.length === 0) {
                container.innerHTML = '<div class="alert-card info"><div class="alert-icon">&#9989;</div><div class="alert-content"><div class="alert-title">All Clear!</div><div class="alert-desc">No capacity alerts at this time.</div></div></div>';
            } else {
                container.innerHTML = alerts.map(a => `
                    <div class="alert-card ${a.type}">
                        <div class="alert-icon">${a.icon}</div>
                        <div class="alert-content">
                            <div class="alert-title">${a.title}</div>
                            <div class="alert-desc">${a.desc}</div>
                        </div>
                    </div>
                `).join('');
            }

            // Capacity forecast from sales pipeline
            const highProbOpportunities = salesFunnel.filter(s => s.probability >= 40);
            const forecastEl = document.getElementById('capacityForecast');
            if (highProbOpportunities.length > 0) {
                forecastEl.innerHTML = `
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Client</th>
                                    <th>Project</th>
                                    <th>Probability</th>
                                    <th>Status</th>
                                    <th>Capacity Needed</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${highProbOpportunities.sort((a, b) => b.probability - a.probability).map(s => `
                                    <tr>
                                        <td><strong style="color: ${colors[s.client] || '#6b7280'}">${s.client}</strong></td>
                                        <td>${s.project || 'â€”'}</td>
                                        <td><span style="color: ${s.probability >= 60 ? 'var(--success)' : 'var(--warning)'}; font-weight: 600;">${s.probability}%</span></td>
                                        <td>${s.status}</td>
                                        <td><span style="color: var(--gray-500);">EL + PL team</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                forecastEl.innerHTML = '<p style="color: var(--gray-500); padding: 20px; text-align: center;">No high-probability opportunities in pipeline</p>';
            }
        }

        // ============================================
        // TIMELINE
        // ============================================
        function renderTimeline() {
            // Generate timeline from data
            const events = [];

            // Add transitions
            allocations.filter(a => a.status === 'funnel').forEach(a => {
                events.push({
                    title: `${a.resource} transitioning`,
                    desc: `Moving to ${a.client} as ${getRoleLabel(a.role)}`,
                    date: 'In Progress',
                    type: 'warning'
                });
            });

            // Add TBH positions
            allocations.filter(a => a.status === 'tbh').forEach(a => {
                events.push({
                    title: `${a.resource} - ${a.client}`,
                    desc: `TBH role for ${a.client} team - actively recruiting`,
                    date: 'Open',
                    type: 'warning'
                });
            });

            // Add split allocations
            const splitResources = {};
            allocations.forEach(a => {
                if (!splitResources[a.resource]) splitResources[a.resource] = [];
                splitResources[a.resource].push(a);
            });
            Object.entries(splitResources).filter(([k, v]) => v.length > 1).forEach(([name, allocs]) => {
                const clientList = allocs.map(a => `${a.client} (${a.percent}%)`).join(' and ');
                events.push({
                    title: `${name} split allocation`,
                    desc: `Covering ${clientList}`,
                    date: 'Active',
                    type: 'info'
                });
            });

            document.getElementById('timelineContainer').innerHTML = events.length > 0 ? events.map(e => `
                <div class="timeline-item">
                    <div class="timeline-dot ${e.type}"></div>
                    <div class="timeline-content">
                        <div class="timeline-title">${e.title}</div>
                        <div class="timeline-desc">${e.desc}</div>
                        <div class="timeline-date">${e.date}</div>
                    </div>
                </div>
            `).join('') : '<p style="color: var(--gray-500); text-align: center; padding: 40px;">No recent transitions</p>';
        }

        // ============================================
        // TEAM VIEW
        // ============================================
        function searchTeam() {
            const q = document.getElementById('teamSearch').value.toLowerCase();
            const grouped = {};
            allocations.forEach(a => {
                if (!grouped[a.resource]) grouped[a.resource] = [];
                grouped[a.resource].push(a);
            });
            const filtered = Object.entries(grouped).filter(([name]) => name.toLowerCase().includes(q));

            document.getElementById('teamTableBody').innerHTML = filtered.map(([name, allocs]) => {
                const primary = allocs[0];
                const splits = allocs.length > 1 ? allocs.slice(1).map(a => a.client).join(', ') : 'â€”';
                const total = allocs.reduce((sum, a) => sum + a.percent, 0);
                return `
                <tr>
                    <td><strong>${name}</strong></td>
                    <td><span style="color: ${colors[primary.client] || '#6b7280'}">${primary.client}</span></td>
                    <td><span class="resource-type-badge ${primary.role.toLowerCase()}">${getRoleLabel(primary.role)}</span></td>
                    <td>${splits}</td>
                    <td><strong>${total}%</strong></td>
                    <td><span class="status-badge ${primary.status}">${getStatusLabel(primary.status)}</span></td>
                </tr>
            `}).join('');
        }

        function renderTeamTable() { searchTeam(); }

        // ============================================
        // REFRESH & EXPORT
        // ============================================
        async function refreshData() {
            await loadAllData();
        }

        function exportToExcel() {
            const wb = XLSX.utils.book_new();

            // Allocations sheet
            const allocData = allocations.map(a => ({
                'Resource': a.resource,
                'Client': a.client,
                'Role': getRoleLabel(a.role),
                'Allocation %': a.percent,
                'Status': getStatusLabel(a.status),
                'Contract': a.contract,
                'Team': a.team,
                'Notes': a.notes
            }));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(allocData), 'Allocations');

            // Sales Funnel sheet
            const salesData = salesFunnel.map(s => ({
                'Client': s.client,
                'Project': s.project,
                'Probability': s.probability + '%',
                'Status': s.status
            }));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(salesData), 'Sales Pipeline');

            // Candidates sheet
            const candidateData = candidates.map(c => ({
                'Name': c.name,
                'Position': c.position,
                'Stage': c.stage,
                'Notes': c.notes
            }));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(candidateData), 'Recruitment');

            XLSX.writeFile(wb, 'ServicePhysics_Dashboard_' + new Date().toISOString().split('T')[0] + '.xlsx');
        }

        function exportToCSV() {
            const headers = ['Resource', 'Client', 'Role', 'Allocation %', 'Status', 'Contract', 'Team', 'Notes'];
            const rows = allocations.map(a => [
                a.resource, a.client, getRoleLabel(a.role), a.percent,
                getStatusLabel(a.status), a.contract, a.team, a.notes
            ]);
            const csv = [headers.join(','), ...rows.map(r => r.map(c => `"${c}"`).join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ServicePhysics_Allocations_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
        }

        // ============================================
        // CHARTS
        // ============================================
        let charts = {};

        function initCharts() {
            // Destroy existing charts
            Object.values(charts).forEach(c => c?.destroy?.());
            charts = {};

            // Client allocation chart
            const clientCounts = clients.map(c => allocations.filter(a => a.client === c).length);
            charts.client = new Chart(document.getElementById('clientChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: clients,
                    datasets: [{
                        label: 'Team Members',
                        data: clientCounts,
                        backgroundColor: clients.map(c => colors[c] || '#6b7280'),
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                        x: { grid: { display: false } }
                    }
                }
            });

            // Role distribution chart
            const roles = { EL: 0, PL: 0, Special: 0, TBH: 0 };
            allocations.forEach(a => roles[a.role] = (roles[a.role] || 0) + 1);
            charts.role = new Chart(document.getElementById('roleChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Engagement Leads', 'Project Leads', 'Special Projects', 'To Be Hired'],
                    datasets: [{
                        data: [roles.EL, roles.PL, roles.Special, roles.TBH],
                        backgroundColor: ['#2563eb', '#10b981', '#8b5cf6', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: { legend: { position: 'right' } }
                }
            });

            // Sales stage chart
            const salesStages = {};
            salesFunnel.forEach(s => salesStages[s.status] = (salesStages[s.status] || 0) + 1);
            const stageLabels = Object.keys(salesStages);
            const stageData = Object.values(salesStages);
            const stageColors = ['#94a3b8', '#8b5cf6', '#f59e0b', '#06b6d4', '#10b981', '#059669', '#ef4444'];

            if (document.getElementById('salesStageChart')) {
                charts.salesStage = new Chart(document.getElementById('salesStageChart').getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: stageLabels,
                        datasets: [{
                            label: 'Opportunities',
                            data: stageData,
                            backgroundColor: stageLabels.map((_, i) => stageColors[i % stageColors.length]),
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                            x: { grid: { display: false } }
                        }
                    }
                });
            }

            // Sales by client chart
            const salesByClient = {};
            salesFunnel.forEach(s => salesByClient[s.client] = (salesByClient[s.client] || 0) + 1);
            const salesClients = Object.keys(salesByClient).slice(0, 10);
            const salesClientData = salesClients.map(c => salesByClient[c]);

            if (document.getElementById('salesClientChart')) {
                charts.salesClient = new Chart(document.getElementById('salesClientChart').getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: salesClients,
                        datasets: [{
                            label: 'Opportunities',
                            data: salesClientData,
                            backgroundColor: salesClients.map(c => colors[c] || '#6b7280'),
                            borderRadius: 6
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                            y: { grid: { display: false } }
                        }
                    }
                });
            }

            // Capacity chart
            const splitResources = {};
            allocations.forEach(a => {
                if (!splitResources[a.resource]) splitResources[a.resource] = [];
                splitResources[a.resource].push(a);
            });
            const resourceNames = Object.keys(splitResources);
            const datasets = clients.map(client => ({
                label: client,
                data: resourceNames.map(r => {
                    const alloc = splitResources[r].find(a => a.client === client);
                    return alloc ? alloc.percent : 0;
                }),
                backgroundColor: colors[client] || '#6b7280',
                borderRadius: 2
            }));

            charts.capacity = new Chart(document.getElementById('capacityChart').getContext('2d'), {
                type: 'bar',
                data: { labels: resourceNames, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        x: { stacked: true, max: 150, grid: { color: '#f1f5f9' } },
                        y: { stacked: true, grid: { display: false } }
                    }
                }
            });

            // Utilization chart
            const multiClientResources = Object.entries(splitResources).filter(([k, v]) => v.length > 1);
            if (multiClientResources.length > 0 && document.getElementById('utilizationChart')) {
                charts.utilization = new Chart(document.getElementById('utilizationChart').getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: multiClientResources.map(([name]) => name),
                        datasets: [{
                            label: 'Total Allocation',
                            data: multiClientResources.map(([_, allocs]) => allocs.reduce((sum, a) => sum + a.percent, 0)),
                            backgroundColor: multiClientResources.map((_, i) => avatarColors[i % avatarColors.length]),
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, max: 120, grid: { color: '#f1f5f9' } },
                            x: { grid: { display: false } }
                        }
                    }
                });
            }

            // Coverage chart
            if (document.getElementById('coverageChart')) {
                charts.coverage = new Chart(document.getElementById('coverageChart').getContext('2d'), {
                    type: 'radar',
                    data: {
                        labels: clients.slice(0, 8),
                        datasets: [{
                            label: 'Team Size',
                            data: clients.slice(0, 8).map(c => allocations.filter(a => a.client === c).length),
                            backgroundColor: 'rgba(37, 99, 235, 0.2)',
                            borderColor: '#2563eb',
                            pointBackgroundColor: '#2563eb'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { r: { beginAtZero: true } }
                    }
                });
            }

            // Conversion chart
            if (document.getElementById('conversionChart')) {
                const statusCounts = {
                    converted: allocations.filter(a => a.status === 'converted').length,
                    funnel: allocations.filter(a => a.status === 'funnel').length,
                    tbh: allocations.filter(a => a.status === 'tbh').length
                };
                charts.conversion = new Chart(document.getElementById('conversionChart').getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: ['Active/Converted', 'In Transition', 'To Be Hired'],
                        datasets: [{
                            data: [statusCounts.converted, statusCounts.funnel, statusCounts.tbh],
                            backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'right' } }
                    }
                });
            }

            // Gap chart
            if (document.getElementById('gapChart')) {
                const gapData = clients.map(c => {
                    const clientAllocs = allocations.filter(a => a.client === c);
                    return clientAllocs.filter(a => a.status === 'tbh' || a.status === 'funnel').length;
                });
                charts.gap = new Chart(document.getElementById('gapChart').getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: clients,
                        datasets: [{
                            label: 'Open Positions',
                            data: gapData,
                            backgroundColor: '#ef4444',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                            x: { grid: { display: false } }
                        }
                    }
                });
            }
        }
    </script>
</body>
</html>
